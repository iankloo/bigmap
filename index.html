<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>COVID-19 Map</title>
  </head>
  
  <body> 


 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>

       <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

      <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

<link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>

<script src="moment.js"></script>


  <script type='text/javascript' src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


<script src="echarts.min.js"></script>


   <style>

    .ui-slider-tick-mark{
      display:inline-block;
      width:1px;
      background:black;
      height:2px;
      position:absolute;
      left:-2 px;
      top: 4.5px;
    }

    #slider label {
      position: absolute;
      width: 20px;
      margin-top: 20px;
      margin-left: -10px;
      text-align: center;
    }

    body {
        padding: 0;
        margin: 0;
    }

		#mapid { 
      height: 100%; 
      width: 100%;
    }



    #title{
      margin-bottom: 20px;
    }
    #metric_input{
      padding-left: 20px;
      padding-top: 10px;
      padding-bottom: 10px;
      padding-right: 10px;
    }


    .info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }
    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    
    .legend {
      line-height: 18px;
      color: #555;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    .legend_title{
      display: block;
      text-align: center;
      margin-bottom: -15px;
    }

    .leaflet-control-layers-base > label{
      margin-bottom: 0px !important;
    }


    #slider {
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      width: 500px;
      margin-left: 50px;
      margin-bottom: 50px;
    }

    #play{
      bottom: 8px;
    }




.tooltip_custom {
    position: absolute;
    display: block;
    padding: 5px;
    font-size: 11px;
    visibility: visible;
    margin-top: -2px;
    bottom:100%;
    margin-left: -3.2em;
}

.tooltip .tooltip-arrow {
    bottom: 0;
    left: 50%;
    margin-left: -5px;
    border-top: 5px solid #000000;
    border-right: 5px solid transparent;
    border-left: 5px solid transparent;
    position: absolute;
    width: 0;
    height: 0;
}

.tooltip-inner {
    max-width: 200px;
    padding: 2px 6px;
    color: black;
    text-align: center;
    text-decoration: none;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background-color: rgba(255,255,255,0.8);
    -webkit-border-radius: 4px;
       -moz-border-radius: 4px;
            border-radius: 4px;
}


.ui-slider .ui-slider-handle:focus { outline: 1px dotted gray; }


.block {
      display: block;
   }

   .myButtonBar {
      padding: 10px 10px 4px 6px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255,255,255,0.8);
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
    }

    .block > input{
      margin-right: 5px;
    }

  #slider > label {
    width: 90px;
    margin-left: -40px;
    color: black;
    text-align: center;
    text-decoration: none;
    font: 14px/16px Arial, Helvetica, sans-serif;
    background-color: rgba(255,255,255,0.8);
    -webkit-border-radius: 4px;
       -moz-border-radius: 4px;
            border-radius: 4px;
  }

  fieldset {
    border: none !important;
  }

  #x {
    position: absolute;
    top: 0px;
    right: 0px;
    z-index: 1;
}

  #Btn2{
    position: absolute;
    top: 50%;
    right: 0;
    margin-right: 0;
    transform: rotate(-90deg);
    transform-origin-y: -41px;
    z-index: 1000;
    font-size: 1em;
    transition: 0.1s;
  }

  @media screen and(-webkit-min-device-pixel-ratio:0) {
    #Btn2 {-chrome-:only(; 
       -webkit-transform-origin-y: -46px;
    );} 
  }

  @media screen and (-webkit-min-device-pixel-ratio:0)
    and (min-resolution:.001dpcm) {
      #Btn2{
        -webkit-transform-origin-y: -46px;
      }
  }

.sidebar {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1000;
  top: 0;
  right: 0;
  overflow-x: hidden;
  padding-top: 60px;
  transition: 0.1s;
  background-color: rgba(255,255,255,0.95) !important;

}

.sidebar .closebtn {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  transition: 0.1s;
  background-color: rgba(255,255,255,0.95) !important;


}

.sidebar .closebtn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

.sidebar_txt{
  margin-left: 10%;
  margin-right: 10%;
  font-family: Arial, Helvetica, sans-serif;
  margin-bottom: 100px;
}


 

   </style>

<div id="mapid"></div>

    <input type="button" id="Btn2" value="About the Project" onclick="openNav()" class="btnStyle span3 " /> 

    <div id="mySidebar" class="sidebar">
    	<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">Ã—</a>
    	<div class = 'sidebar_txt'>
        <h2>Welcome to the BigMap COVID-19 Tracking Project!</h2>
        	<p>This is a constantly evolving product and is meant to be "unfinished" in that we will constantly be making improvements as we think of - and have time to implement - them.  Given the time-sensitive nature of the COVID-19 pandemic, we wanted to get our analysis "out there" as quickly as possible while maintaining the quality we would expect from other high-quality data science projects.</p>

        <h2>Functionality</h2>
         	<p>The basic functionality of the map includes:</p>
         	<ul>
            	<li>Change the metric used to color the map with the radio buttons in the top right</li>
            	<li>Select a date using the slider on the bottom right</li>
            	<li>"Play" the historical data, showing how the map changes over time by clicking the button to the left of the time slider</li>
            	<li>Hover over a county to get the name and current value of the selected metric</li>
            	<li>Click on a county to show a timeseries plot of the selected metric in that county</li>
        	</ul>


        <h2>Metrics</h2>
        	<ul>
	            <li><strong>Case Count</strong> - The number of reported COVID-19 Cases</li>
	            <li><strong>% Increase</strong> - Percent increase of COVID-19 cases from the previous day</li>
	            <li><strong>Deaths</strong> - The number of reported COVID-19 Deaths</li>
	            <li><strong>Doubling</strong> - The number of days since there were half as many COVID-19 cases as the current day. <p>Note, some other projects calculate this value using the current trajectory of the disease in a location, but we have opted for a simpler metric that is more interpretable.  Our approach is more of a retrospective look on how a county is doing currently relative to the recent past.</p></li>
	            <li><strong>R(t)</strong> - The effective reproduction number
	            	<p>As per Thompson et al. (2019): "R(t) represents the expected number of secondary cases arising from a primary case infected at time t. This value changes throughout an outbreak. If the value of R(t) is and remains below one, the outbreak will die out. However, while R(t) is larger than one, a sustained outbreak is likely. The aim of control interventions is typically to reduce the reproduction number below one."</p>
	            	<p>Because R(t) is sensitive to reporting abnormalities that may occur day-to-day, we provide smoothed metrics for 3- and 7-day time scales.</p>
                <p>For more details on the R(t) metric used in this project, see <a href = 'https://github.com/nick3703/Parametric-Modeling-for-Time-Varying-Reproducibility-Number'>Nick Clark's Git Repo</a></p>
	            </li>
              <li><strong>Infectious Probability</strong> - The probability that someone on the street is infectious
                <p>This probability is calculated by dividing the number of people who have COVID-19 (but are not hospitalized) by a county's total population.  The number of non-hospitalized people with COVID-19 is based on the following assumptions:</p>
                <ul>
                  <li>Number of days between symptoms and getting a positive test result = 2 days (source: https://www.labcorp.com/tests/139900/2019-novel-coronavirus-covid-19-naa)</li>
                  <li>Number of days infectious after showing symptoms = 10 days (source: https://www.medrxiv.org/content/10.1101/2020.03.05.20030502v1)</li>
                  <li>Number of days between symptoms and hospitalization (if hospitalized) = 7 (source: https://jamanetwork.com/journals/jama/fullarticle/2761044)</li>
                  <li>Undetected cases (i.e., amount of people who likely have the virus and are not captured in the positive testing numbers) = 10x (source: https://science.sciencemag.org/content/368/6490/489)</li>
                  <li>Hospitalization rates of infected people by age (source: https://www.thelancet.com/action/showPdf?pii=S1473-3099%2820%2930243-7)</li>
                </ul>
              </li>
              <p>Using these assumptions, we calculate the number of infectious people in the population by finding the number of people who tested positive within the infectious period, multiplying by the undetected case figure, and subtracting the number of people who are likely to have been hospitalized (based on the age demographics of a county).</p>
              <p>Note 1: Because there are so many assumptions baked into this metric, it is certainly not the exact probability that a person on the street is infected.  If we assume, however, that these assumptions are fairly stable across counties, we can compare the numbers to get an idea of relative risk between locations.</p>
              <p>Note 2: This probability should be considered like a geographically informed prior.  There are many other things that need to be accounted for when assigning a probability that an individual is infected.  For example, if you go to a bar, the probability that an individual is infectious is probably much higher than the number we report.  Bars are filled with people who are (likely regularly) engaging in behavior that may expose them to the virus.  Conversely, a person in the waiting room at a doctor's office is probably much less likely to be infectious than our metric.  Doctor's offices require temperature checks and screening surveys that lower the probability of an infectious person sitting in the waiting room.</p>
        	</ul>


        <h2>Methodology and Technology</h2>

        	The map was created with the goal of visualizing the spatial and temporal distributions of various COVID-19 statistics.  While there are many similar projects, this one is focused on allowing for easy traversal of time and space.  To that end, we have a pseudo-animation feature that lets the user "play out" the pandemic over the country with any metric they choose.  At the county level, we give the user the ability to click to see a timeseries visualization for the selected metric.  In combination, we aim to give users multiple approaches to visually interrogate the current and past states of the COVID-19 pandemic across a number of metrics.

	    	See the <a href = 'https://github.com/iankloo/bigmap'>repository for the map</a> for the full code base.  More documentation is forthcoming there. 

	    	<h4>Data</h4>
	    		<p>The data used to generate the map is generated by an R script that is run daily.  We are constantly updating this file and it is not stable enough to release publicly at this stage.  Eventually, we will add this munge file to the repository.</p>

	    		<p>The case counts and deaths are sourced from <a href = 'https://usafacts.org'>USA Facts</a>.  This is the best county-level data set we have found, and it is consistently updated daily.  The remainder of the fields are calculated using team's internally developed methodologies.</p>

        	<h4>Mapping</h4>
        		<p>This map is a fairly vanilla Leaflet implementation with Javascript (and jQuery) used to implement additional functionality.  I stayed away from Leaflet plugins for the most part because they are generally pretty rigid in their implementation and I am particular.  The layers on the map are sourced by a geojson created from US Census county boundary shape files.</p>

        	<h4>Time Slider</h4>
        		<p>The timeline controls were manually created and added as Leaflet control layers.  Adding custom control layers allows for arbitrary HTML elements to be included "on top" of the map.  We used jQuery to listen for changes to the time slider which then updates the map using the data for that specific date.  The "play" button starts iterating the time slider by one tick on a set time interval (starting either at the current location of the time slider or restarting at the beginning if the slider is in the last position).</p>

        	<h4>Timeseries Visualization</h4>
        		<p>Clicking on a county produces a timeseries using <a href = 'https://echarts.apache.org'>Apache's Echarts</a> Javascript implementation.  While a user could find the same information by adjusting the time slider, seeing the data in one timeseries visualization supports questions like, "how bad was the COVID-19 pandemic in county X?"</p>

       		<h4>Colors</h4>
	            <p>Colors are one of the most controversial topics when it comes to any visualization.  We chose to go with a yellow-to-red scale, using grey for NA values.  The intent is to get close to an intensity scale while maintaining readability for people with and without color blindness.</p>
	            <p>Color thresholds are a tricky and are being constantly reevaluated.  If possible, we try to make the thresholds meaningful.  For example, an R(t) below 0 represents a "good" situation in that case count should continue to decrease so we assign the first threshold at 1 for the R(t) scales.</p>

        <h2>About the Authors</h2>
          <h4>Ian Kloo</h4>
          <p>Ian is a data scientist and is the lead developer on the BigMap project.</p>

          <h4>Nick Clark</h4>
          <p>Nick is a statistician and creator of the R(t) statistic used on the BigMap project.</p>

        <h2>Problems, Concerns, or Feedback?</h2>
          <p>Please <a href = 'https://github.com/iankloo/bigmap/issues'>submit an issue</a> on the project repository and we'll do our best to address it/get back to you.</p>
      </div>
    </div>



  </body>

  <script>






function openNav() {
  if(document.getElementById("Btn2").style.marginRight == "50%"){
    document.getElementById("mySidebar").style.width = "0";
    document.getElementById("Btn2").style.marginRight = "0";
  } else{
    document.getElementById("mySidebar").style.width = "50%";
    document.getElementById("Btn2").style.marginRight = "50%";
  }
}

function closeNav() {
  document.getElementById("mySidebar").style.width = "0";
  //document.getElementById("main").style.marginRight= "0";
  document.getElementById("Btn2").style.marginRight = "0";
}




  //--------colors for each layer--------//
  function getColor_cases(d) {
    return d > 10000 ? '#BD0026' :
           d > 1000  ? '#F03B20' :
           d > 100   ? '#FD8D3C' :
           d > 10   ? '#FECC5C' :
           d > 0    ? '#FFFFB2' :
                      '#808080';
  } 

  function getColor_per_delta(d) {
      return d > 200 ? '#800026' :
             d > 100  ? '#BD0026' :
             d > 50  ? '#E31A1C' :
             d > 20  ? '#FC4E2A' :
             d > 10   ? '#FD8D3C' :
             d > 5   ? '#FEB24C' :
             d > 0   ? '#FED976' :
                        '#808080';
    } 

  function getColor_rt(d) {
    return d > 4 ? '#BD0026' :
           d > 3  ? '#F03B20' :
           d > 2   ? '#FD8D3C' :
           d > 1   ? '#FECC5C' :
           d > 0   ? '#FFFFB2'  :
                      '#808080';
  }

  function getColor_rt_three(d) {
    return d > 4 ? '#BD0026' :
           d > 3  ? '#F03B20' :
           d > 2   ? '#FD8D3C' :
           d > 1   ? '#FECC5C' :
           d > 0   ? '#FFFFB2'  :
                      '#808080';
  }

  function getColor_rt_seven(d) {
    return d > 4 ? '#BD0026' :
           d > 3  ? '#F03B20' :
           d > 2   ? '#FD8D3C' :
           d > 1   ? '#FECC5C' :
           d > 0   ? '#FFFFB2'  :
                      '#808080';
  }

  function getColor_death(d) {
    return d > 1000 ? '#BD0026' :
           d > 100  ? '#F03B20' :
           d > 10   ? '#FD8D3C' :
           d > 0    ? '#FFFFB2' :
           			   '#808080';

  }



    function getColor_doubling(d) {

    	if(d == null){
    		return('#808080')
    	} else if(d < 2){
    		return('#BD0026')
    	} else if(d < 5){
    		return('#F03B20')
    	} else if(d < 10){
    		return('#FD8D3C')
    	} else if(d < 20){
    		return('#FECC5C')
    	} else {
    		return('#FFFFB2')
    	}


  }


  //   function getColor_infectprob(d) {
  //   return d > 5 ? '#BD0026' :
  //          d > 2  ? '#F03B20' :
  //          d > 1   ? '#FD8D3C' :
  //          d > .5   ? '#FECC5C' :
  //          d > 0   ? '#FFFFB2'  :
  //                     '#808080';
  // }

    function getColor_infectprob(d) {
      return d > 10 ? '#800026' :
             d > 9  ? '#B10026' :
             d > 8  ? '#D41121' :
             d > 7   ? '#ED3321' :
             d > 6   ? '#FD5D2D' :
             d > 5   ? '#FD8D3C' :
             d > 4   ? '#FEAB49' :
             d > 3   ? '#FFC965' :
             d > 2   ? '#FFE187' :
             d > 1   ? '#FFF1A9' :
             d > 0   ? '#FFFFCC' :
                        '#808080';
    }
    


  //--------highlight controls for each layer--------//
  function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        weight: 2,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }

  }

  function buildCaseLayer(my_data_var){

    function resetHighlight_cases(e) {
      case_layer.resetStyle(e.target);
    }

    function onEachFeature_cases(feature, layer) {
      layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight_cases
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>Cases: ' + feature.properties[my_data_var])
    }

    function style_cases(feature){
      return{
        fillColor: getColor_cases(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    case_layer = L.geoJSON(counties, {
      style: style_cases,
      onEachFeature: onEachFeature_cases
    }).addTo(mymap);

    case_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}


    	L.Control.Plot = L.Control.extend({
				onAdd: function(map) {
			      var container = L.DomUtil.create('div', 'search-container');
			      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

			      //L.DomEvent.disableClickPropagation(container);

			      return container;
			    },

			    onRemove: function(map) {
			        // Nothing to do here
				    }
			})



			L.control.plot = function(opts){
				return new L.Control.Plot(opts)
			}

    	$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.case_count);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of Cases in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'Cases',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})


    })

  }

  function buildDeltaLayer(my_data_var){

    function resetHighlight_per_inc(e) {
      per_inc_layer.resetStyle(e.target);
    }

    function onEachFeature_per_inc(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_per_inc
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>Increase: ' + feature.properties[my_data_var] + "%")
    }

    function style_per_inc(feature){
      return{
        fillColor: getColor_per_delta(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    per_inc_layer = L.geoJSON(counties, {
      style: style_per_inc,
      onEachFeature: onEachFeature_per_inc
    }).addTo(mymap);

    per_inc_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

		L.Control.Plot = L.Control.extend({
		onAdd: function(map) {
	      var container = L.DomUtil.create('div', 'search-container');
	      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

	      //L.DomEvent.disableClickPropagation(container);

	      return container;
	    },

	    onRemove: function(map) {
	        // Nothing to do here
		    }
		})

		L.control.plot = function(opts){
			return new L.Control.Plot(opts)
		}

		$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.delta);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of % Increase in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: '% Change',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
	 })
  }

  function buildRtLayer(my_data_var){

    function resetHighlight_rt(e) {
      rt_layer.resetStyle(e.target);
    }

    function onEachFeature_rt(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_rt
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>R(t): ' + feature.properties[my_data_var])
    }

    function style_rt(feature){
      return{
        fillColor: getColor_rt(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    rt_layer = L.geoJSON(counties, {
      style: style_rt,
      onEachFeature: onEachFeature_rt
    }).addTo(mymap);


    rt_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

		L.Control.Plot = L.Control.extend({
		onAdd: function(map) {
	      var container = L.DomUtil.create('div', 'search-container');
	      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

	      //L.DomEvent.disableClickPropagation(container);

	      return container;
	    },

	    onRemove: function(map) {
	        // Nothing to do here
		    }
		})

		L.control.plot = function(opts){
			return new L.Control.Plot(opts)
		}

		$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.r_t);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of R(t) in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'R(t)',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
	 })
  }

function buildRtThreeLayer(my_data_var){

    function resetHighlight_rt_three(e) {
      rt_three_layer.resetStyle(e.target);
    }

    function onEachFeature_rt_three(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_rt_three
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>R(t) 3-Day Avg: ' + feature.properties[my_data_var])
    }

    function style_rt_three(feature){
      return{
        fillColor: getColor_rt_three(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    rt_three_layer = L.geoJSON(counties, {
      style: style_rt_three,
      onEachFeature: onEachFeature_rt_three
    }).addTo(mymap);




    rt_three_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

		L.Control.Plot = L.Control.extend({
		onAdd: function(map) {
	      var container = L.DomUtil.create('div', 'search-container');
	      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

	      //L.DomEvent.disableClickPropagation(container);

	      return container;
	    },

	    onRemove: function(map) {
	        // Nothing to do here
		    }
		})

		L.control.plot = function(opts){
			return new L.Control.Plot(opts)
		}

		$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.r_t_three);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of R(t) (3-Period) in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'R(t) 3-Period',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
	})
  }


  function buildRtSevenLayer(my_data_var){

    function resetHighlight_rt_seven(e) {
      rt_seven_layer.resetStyle(e.target);
    }

    function onEachFeature_rt_seven(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_rt_seven
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>R(t) 7-Day Avg: ' + feature.properties[my_data_var])
    }

    function style_rt_seven(feature){
      return{
        fillColor: getColor_rt_seven(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    rt_seven_layer = L.geoJSON(counties, {
      style: style_rt_seven,
      onEachFeature: onEachFeature_rt_seven
    }).addTo(mymap);


    rt_seven_layer.on('click', function(e){

      if(typeof testlayer !== "undefined"){
        mymap.removeControl(testlayer)
      }

    L.Control.Plot = L.Control.extend({
    onAdd: function(map) {
        var container = L.DomUtil.create('div', 'search-container');
        container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

        //L.DomEvent.disableClickPropagation(container);

        return container;
      },

      onRemove: function(map) {
          // Nothing to do here
        }
    })

    L.control.plot = function(opts){
      return new L.Control.Plot(opts)
    }

    $.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.r_t_seven);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of R(t) (7-Period) in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'R(t) 7-Period',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
    })
  }


  function buildDeathLayer(my_data_var){

    function resetHighlight_death(e) {
      death_layer.resetStyle(e.target);
    }

    function onEachFeature_death(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_death
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>Deaths: ' + feature.properties[my_data_var])
    }

    function style_death(feature){
      return{
        fillColor: getColor_death(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    death_layer = L.geoJSON(counties, {
      style: style_death,
      onEachFeature: onEachFeature_death
    }).addTo(mymap);


    death_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

		L.Control.Plot = L.Control.extend({
		onAdd: function(map) {
	      var container = L.DomUtil.create('div', 'search-container');
	      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

	      //L.DomEvent.disableClickPropagation(container);

	      return container;
	    },

	    onRemove: function(map) {
	        // Nothing to do here
		    }
		})

		L.control.plot = function(opts){
			return new L.Control.Plot(opts)
		}

		$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.deaths);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of Deaths in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'Deaths',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
	})
  }


  function buildDoublingLayer(my_data_var){

    function resetHighlight_doubling(e) {
      doubling_layer.resetStyle(e.target);
    }

    function onEachFeature_doubling(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_doubling
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>Days to Double: ' + feature.properties[my_data_var])
    }

    function style_doubling(feature){
      return{
        fillColor: getColor_doubling(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    doubling_layer = L.geoJSON(counties, {
      style: style_doubling,
      onEachFeature: onEachFeature_doubling
    }).addTo(mymap);

    doubling_layer.on('click', function(e){

    	if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

		L.Control.Plot = L.Control.extend({
		onAdd: function(map) {
	      var container = L.DomUtil.create('div', 'search-container');
	      container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

	      //L.DomEvent.disableClickPropagation(container);

	      return container;
	    },

	    onRemove: function(map) {
	        // Nothing to do here
		    }
		})

		L.control.plot = function(opts){
			return new L.Control.Plot(opts)
		}

		$.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.doubling);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of Doubling in ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'Doubling',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
	})
  }


  function buildInfectProbLayer(my_data_var){

    function resetHighlight_infectprob(e) {
      infectprob_layer.resetStyle(e.target);
    }

    function onEachFeature_infectprob(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight_infectprob
      });
      layer.bindTooltip('<b>'+feature.properties.NAME + '</b><br>Infect Prob: ' + feature.properties[my_data_var]+'%')
    }

    function style_infectprob(feature){
      return{
        fillColor: getColor_infectprob(feature.properties[my_data_var]),
        weight: .2,
        opacity: 1,
        color: 'grey',
        fillOpacity: 0.7
      }
    }

    infectprob_layer = L.geoJSON(counties, {
      style: style_infectprob,
      onEachFeature: onEachFeature_infectprob
    }).addTo(mymap);


    infectprob_layer.on('click', function(e){

      if(typeof testlayer !== "undefined"){
        mymap.removeControl(testlayer)
      }

    L.Control.Plot = L.Control.extend({
    onAdd: function(map) {
        var container = L.DomUtil.create('div', 'search-container');
        container.innerHTML = '<div class = "info"> <button id = "x">X</button><div id="main" style="width:450px; height:275px;"></div> </div>';

        //L.DomEvent.disableClickPropagation(container);

        return container;
      },

      onRemove: function(map) {
          // Nothing to do here
        }
    })

    L.control.plot = function(opts){
      return new L.Control.Plot(opts)
    }

    $.ajax({
		    url:"chart_data/"+e.layer.feature.properties.FIPS+".json",
		    dataType: "json",
		    success: function(d){

		    	var plot_dat = d.map(a => a.infect_prob);
		    	var dates = d.map(a => a.date)

		    	testlayer = L.control.plot({position: 'topleft'}).addTo(mymap)

		    	var myChart = echarts.init(document.getElementById('main'));

		        // specify chart configuration item and data
		        var option = {
		            title: {
		                text: 'Timeseries of Infectious Probability \nin ' + d[0]['County Name']
		            },
		            toolbox: {
		               bottom: '0px',
			           feature: {
			               saveAsImage : {show: true, title: " "}

			           }
			       },
		            tooltip: {trigger:"axis"},
		            xAxis: {
		                data: dates
		            },
		            yAxis: {},
		            series: [{
		                name: 'Infectious Probability',
		                type: 'line',
		                data: plot_dat
		            }]
		        };

		        // use configuration item and data specified to show chart
		        myChart.setOption(option);


		        $("#x").click(function(){
		    		mymap.removeControl(testlayer)
		    	})
		    }
		})
  	})
  }


  //--------legend for each layer--------//
  legend_cases = L.control({position: 'bottomright'});
  legend_cases.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          cases = [10000, 1000, 100, 10, 0],
          labels = ['<span class = "legend_title"><strong> Cases </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < cases.length; i++) {
          div.innerHTML +=
            labels.push(
              '<i style="background:' + getColor_cases(cases[i] + 1) + '"></i> ' +
              '> ' + cases[i]);
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0 or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

  legend_rt = L.control({position: 'bottomright'});
  legend_rt.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          rt = [4, 3, 2, 1, 0],
          labels = ['<span class = "legend_title"><strong> R(t) </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < rt.length; i++) {
          div.innerHTML +=
            labels.push(
              '<i style="background:' + getColor_rt(rt[i] + 1) + '"></i> ' +
              '> ' + rt[i]);
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0 or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

legend_rt_three = L.control({position: 'bottomright'});
  legend_rt_three.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          rt = [4, 3, 2, 1, 0],
          labels = ['<span class = "legend_title"><strong> R(t) 3-Day Avg </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < rt.length; i++) {
          div.innerHTML +=
            labels.push(
              '<i style="background:' + getColor_rt_three(rt[i] + 1) + '"></i> ' +
              '> ' + rt[i]);
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0 or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

  legend_rt_seven = L.control({position: 'bottomright'});
    legend_rt_seven.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            rt = [4, 3, 2, 1, 0],
            labels = ['<span class = "legend_title"><strong> R(t) 7-Day Avg </strong></span>'];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < rt.length; i++) {
            div.innerHTML +=
              labels.push(
                '<i style="background:' + getColor_rt_seven(rt[i] + 1) + '"></i> ' +
                '> ' + rt[i]);
        }
        div.innerHTML +=
          labels.push('<i style="background: #808080"></i>' + "0 or NA")
        div.innerHTML = labels.join('<br>');
        return div;
  };


  legend_per_delta = L.control({position: 'bottomright'});
  legend_per_delta.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          per_delta = [200, 100, 50, 20, 10, 5, 0],
          labels = ['<span class = "legend_title"><strong> % Increase </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < per_delta.length; i++) {
          div.innerHTML +=
          labels.push(
              '<i style="background:' + getColor_per_delta(per_delta[i] + 1) + '"></i> ' +
              '> ' + per_delta[i] + '%');
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0 or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

  legend_death = L.control({position: 'bottomright'});
  legend_death.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          death = [1000, 100, 10, 0],
          labels = ['<span class = "legend_title"><strong> Deaths </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < death.length; i++) {
          div.innerHTML +=
          labels.push(
              '<i style="background:' + getColor_death(death[i] + 1) + '"></i> ' +
              '> ' + death[i]);
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0 or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };


  legend_doubling = L.control({position: 'bottomright'});
  legend_doubling.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          doubling = [2, 5, 10, 20, 20],
          colors = ['#BD0026', '#F03B20', '#FD8D3C', '#FECC5C', '#FFFFB2']
          labels = ['<span class = "legend_title"><strong> Days to Double </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < doubling.length; i++) {
      	if(i == doubling.length - 1){
      		div.innerHTML +=
	          labels.push(
	              '<i style="background:' + colors[i] + '"></i> ' +
	              '>= ' + doubling[i]);
      	} else{
      		div.innerHTML +=
	          labels.push(
	              '<i style="background:' + colors[i] + '"></i> ' +
	              '< ' + doubling[i]);
      	}
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

  legend_infectprob = L.control({position: 'bottomright'});
    legend_infectprob.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'info legend'),
          infectprob = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0],
          labels = ['<span class = "legend_title"><strong> Infectious Probability </strong></span>'];

      // loop through our density intervals and generate a label with a colored square for each interval
      for (var i = 0; i < infectprob.length; i++) {
          div.innerHTML +=
            labels.push(
              '<i style="background:' + getColor_infectprob(infectprob[i] + 1) + '"></i> ' +
              '> ' + infectprob[i] + '%');
      }
      div.innerHTML +=
        labels.push('<i style="background: #808080"></i>' + "0% or NA")
      div.innerHTML = labels.join('<br>');
      return div;
  };

 




  //--------read in data and start the map--------//


	// $.ajax({
	//   url: "https://github.com/iankloo/bigmap/tree/master/geojsons/",
	//   success: function(data){
	//   	var last = $(data).find('tr:last > td > a').text()

	//   	var last_date = last.replace('.geojson', '')
	  	
	  	var last_date = '20201107'


	  	$.ajax({
		    url:"geojsons/" + last_date + ".geojson",
		    dataType: "json",
		    success: function(data){
		    	//counties = data
		    	//start map centered on us
				mymap = L.map('mapid').setView([38, -96], 5);

				//---build layers and add them to map---//
				L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
				  attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
				  maxZoom: 16
				}).addTo(mymap);




				L.Control.Buttons = L.Control.extend({
				  onAdd: function(map){
				  //create div container for control
				  var div = L.DomUtil.create('div', 'myButtonBar');
				  //prevent mouse events from propagating through to the map
				  L.DomEvent.disableClickPropagation(div);
				  //create custom radio buttons
				  div.innerHTML = '<form>'
				    + '<label class="block"><input class = "base_btn" type="radio" name="radgroup" value="case_count">Case Count</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="per_inc">% Increase</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="rt">R(t) Daily</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="rt_three">R(t) 3-Day Avg</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="rt_seven">R(t) 7-Day Avg</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="deaths">Deaths</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="doubling">Doubling</label>'
				    + '<label class="block base_btn"><input class = "base_btn" type="radio" name="radgroup" value="infectprob" checked = checked>Infectious Probability</label>'
				    + '</form>'
				  return div;
				  }
				})

				L.control.buttons = function(opts){
				  return new L.Control.Buttons(opts);
				}

				L.control.buttons({position: 'topright'}).addTo(mymap)

				  $('input[name="radgroup"]').change(function(e) {
				  	//console.log($(this).val())
				 //  	mymap.eachLayer(function (layer) {
				 //  		console.log(layer)
					//     mymap.removeLayer(layer);
					// });
				  	build_map(data, $(this).val())
				  })


				L.Control.Slider = L.Control.extend({
		    		onAdd: function(map) {
				      var container = L.DomUtil.create('div', 'search-container');
				      container.innerHTML = '<fieldset><div class = "controlgroup"><button id = "play" class="">&#9658;</button><div id="slider"></div></div></fieldset>';

				      L.DomEvent.disableClickPropagation(container);

				      return container;
				    },

				    onRemove: function(map) {
				        // Nothing to do here
				    }
				});

				L.control.slider = function(opts) {
				    return new L.Control.Slider(opts);
				}

				L.control.slider({ position: 'bottomleft' }).addTo(mymap);


				$( ".controlgroup" ).controlgroup()

				  String.prototype.splice = function(idx, rem, str) {
				    return this.slice(0, idx) + str + this.slice(idx + Math.abs(rem));
				  };


				    mindate = new Date('2020-03-02').getTime();
				    maxdate = new Date(last_date.slice(0, 4) + "-" + last_date.slice(4, 6) + "-" + last_date.slice(6, 8)).getTime() + 86400000

				    $( "#slider" ).slider({
				      range: false,
				      min: mindate,
				      max: maxdate,
				      step: 86400000,
				      value: [ mindate ],
				      create: function(event, ui){
				        setSliderTicks(event.target)
				      },
				      slide: function(event, ui){
				        var cur_date = getFormattedDate(new Date(ui.value))

				        var tooltip = '<div class="tooltip_custom"><div class="tooltip-inner">' + cur_date + '</div><div class="tooltip-arrow"></div></div>';

				            $('.ui-slider-handle').html(tooltip); //attach tooltip to the slider handle

				      },
				      change: function(event, ui){

				        //get currently selected layer
				        var cur_layer = $('input[name="radgroup"]:checked').val()
				        var cur_date = getFormattedDate(new Date(ui.value))

				        var d = new Date(ui.value)
				        var date_fixed = d.yyyymmdd()

				        var tooltip = '<div class="tooltip_custom"><div class="tooltip-inner">' + cur_date + '</div><div class="tooltip-arrow"></div></div>';

				        $('.ui-slider-handle').html(tooltip); //attach tooltip to the slider handle

				        $.ajax({
						    url:"geojsons/"+date_fixed+".geojson",
						    dataType: "json",
						    success: function(data){
						    	build_map(data, cur_layer)
						    },
						    error: function (xhr) {
						      alert(xhr.statusText)
						    }
						 })

				     
				      }
				    });


				function setSliderTicks(el) {
				    var $slider =  $(el);
				    var max =  $slider.slider("option", "max");    
				    var min =  $slider.slider("option", "min");        
				    var step = $slider.slider("option", "step");
				    var spacing =  100/((max - min)/step);

				    $slider.find('.ui-slider-tick-mark').remove();
				    for (var i = 0; i < ((max-min)/step) ; i++) {
				        $('<span class="ui-slider-tick-mark"></span>').css('left', (spacing * i) +  '%').appendTo($slider); 

				        if(i == 0){
				          d = new Date(mindate)
				          d_str = getFormattedDate(d)
				          var el = $('<label>' + d_str + '</label>').css('left', (spacing * i) + '%').appendTo($slider);
				        } else if(i == ((max-min)/step)-1){
				          d = new Date(maxdate)
				          d_str = getFormattedDate(d)
				          var el = $('<label>' + d_str + '</label>').css('left', (spacing * i) + '%').appendTo($slider);

				        }
				     }
				 }


				 function getFormattedDate(date) {
					  var year = date.getFullYear();

					  var month = (1 + date.getMonth()).toString();
					  month = month.length > 1 ? month : '0' + month;

					  var day = date.getDate().toString();
					  day = day.length > 1 ? day : '0' + day;
					  
					  return month + '/' + day + '/' + year;
					}

				Date.prototype.yyyymmdd = function() {
				    var mm = this.getMonth() + 1; // getMonth() is zero-based
				    var dd = this.getDate();

				    return [this.getFullYear(),
				            (mm>9 ? '' : '0') + mm,
				            (dd>9 ? '' : '0') + dd
				           ].join('');
				  };


				  $("#play").click( function() {

				    current = $("#slider").slider('value')

				    if(current == maxdate){
				      $("#slider").slider("option", "value", mindate)
				    }

				    //$("#play").html('&#9612;&#9612;')

				    
				    int = setInterval(function(){
				      current = $("#slider").slider('value')
				      $("#slider").slider("option", "value", current + 86400000);

				      if ((current + 86400000) == maxdate) {
				        clearInterval(int);
				        //$("#play").html('&#9658;')
				      }

				    }, 750)
				    
				  })





				$("#slider").slider("option", "value", maxdate)




		    	//build_map(data, 'case_count')
		    },
		    error: function (xhr) {
		      alert(xhr.statusText)
		    }
		  })
	//   }
	// });




  


	// $.when(counties).done(function() {
	// 	build_map()
	// })




  function build_map(data, sel) {

  	counties = data

    //$('input[name="radgroup"]').change(function(e) { // Select the radio input group
      //var selection = $('input[name="radgroup"]').val()

      var selection = sel

      if(typeof testlayer !== "undefined"){
    		mymap.removeControl(testlayer)
    	}

    if(typeof(case_layer) !== 'undefined'){
    	mymap.removeLayer(case_layer)
    }
    if(typeof(per_inc_layer) !== 'undefined'){
    	mymap.removeLayer(per_inc_layer)
    }
    if(typeof(rt_layer) !== 'undefined'){
    	mymap.removeLayer(rt_layer)
    }
    if(typeof(rt_three_layer) !== 'undefined'){
    	mymap.removeLayer(rt_three_layer)
    }
    if(typeof(rt_seven_layer) !== 'undefined'){
    	mymap.removeLayer(rt_seven_layer)
    }
    if(typeof(death_layer) !== 'undefined'){
    	mymap.removeLayer(death_layer)
    }if(typeof(doubling_layer) !== 'undefined'){
    	mymap.removeLayer(doubling_layer)
    }if(typeof(infectprob_layer) !== 'undefined'){
    	mymap.removeLayer(infectprob_layer)
    }

      // mymap.removeLayer(case_layer)
      // mymap.removeLayer(per_inc_layer)
      // mymap.removeLayer(rt_layer)
      // mymap.removeLayer(rt_three_layer)
      // mymap.removeLayer(rt_seven_layer)
      // mymap.removeLayer(death_layer)
      // mymap.removeLayer(doubling_layer)
      // mymap.removeLayer(infectprob_layer)

      if(selection == "per_inc"){

        buildDeltaLayer('per_delta')

        // mymap.removeControl(legend_rt)
        // mymap.removeControl(legend_cases)
        // mymap.removeControl(legend_rt_three)
        // mymap.removeControl(legend_rt_seven)
        // mymap.removeControl(legend_death)
        // mymap.removeControl(legend_doubling)
        // mymap.removeControl(legend_infectprob)
        legend_per_delta.addTo(mymap);

      } else if(selection == "case_count"){

        buildCaseLayer('case_count')

        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_doubling)
        mymap.removeControl(legend_infectprob)
        legend_cases.addTo(mymap);

      } else if(selection == "rt"){
        buildRtLayer('r_t')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_doubling)
        mymap.removeControl(legend_infectprob)
        legend_rt.addTo(mymap);
      } else if(selection == 'rt_three'){

        buildRtThreeLayer('r_t_three')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_doubling)
        mymap.removeControl(legend_infectprob)
        legend_rt_three.addTo(mymap);
      } else if(selection == 'rt_seven'){

        buildRtSevenLayer('r_t_seven')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_doubling)
        mymap.removeControl(legend_infectprob)
        legend_rt_seven.addTo(mymap);
      } else if(selection == 'deaths'){

        buildDeathLayer('deaths')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_doubling)
        mymap.removeControl(legend_infectprob)
        legend_death.addTo(mymap);
      } else if(selection == 'doubling'){

        buildDoublingLayer('doubling')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_infectprob)
        legend_doubling.addTo(mymap);
      } else if(selection == 'infectprob'){

        buildInfectProbLayer('infect_prob')

        mymap.removeControl(legend_per_delta)
        mymap.removeControl(legend_cases)
        mymap.removeControl(legend_rt)
        mymap.removeControl(legend_rt_three)
        mymap.removeControl(legend_rt_seven)
        mymap.removeControl(legend_death)
        mymap.removeControl(legend_doubling)
        legend_infectprob.addTo(mymap);
      }

     //});




  

  }









//   $.when(counties).done(function() {

//     //console.log(counties)
      
//     //start map centered on us
//     mymap = L.map('mapid').setView([38, -96], 5);

//     //---build layers and add them to map---//
//     L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
//       attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
//       maxZoom: 16
//     }).addTo(mymap);

//     //initialize layers
//     buildCaseLayer('case_count')
//     buildDeltaLayer('per_delta')
//     buildRtLayer('r_t')
//     buildRtThreeLayer('r_t_three')
//     buildRtSevenLayer('r_t_seven')
//     buildDeathLayer('deaths')
//     buildDoublingLayer('doubling')
//     buildInfectProbLayer('infect_prob')
    
//     //---setup layer controls---//
//     //var baseMaps = {
//     //  "Case Count": case_layer,
//     //  "% Increase": per_inc_layer,
//     //  "R(t)": rt_layer
//     //}
//     //L.control.layers(baseMaps, null, {collapsed:false}).addTo(mymap)
//     //$('.myButtonBar')[0].click()

    
//     //---control which legend is shown---//
//     //start with cases
//     legend_cases.addTo(mymap);
    

  










// L.Control.Slider = L.Control.extend({
//     onAdd: function(map) {
//       var container = L.DomUtil.create('div', 'search-container');
//       container.innerHTML = '<fieldset><div class = "controlgroup"><button id = "play" class="">&#9658;</button><div id="slider"></div></div></fieldset>';

//       L.DomEvent.disableClickPropagation(container);

//       return container;
//     },

//     onRemove: function(map) {
//         // Nothing to do here
//     }
// });

// L.control.slider = function(opts) {
//     return new L.Control.Slider(opts);
// }

// L.control.slider({ position: 'bottomleft' }).addTo(mymap);


// $( ".controlgroup" ).controlgroup()

//   String.prototype.splice = function(idx, rem, str) {
//     return this.slice(0, idx) + str + this.slice(idx + Math.abs(rem));
//   };

//     var prop = counties.responseJSON.features[0].properties
//     var prop_keys = Object.keys(prop)
//     var max_date = prop_keys.slice(-1)[0].replace('r_t_three_', '')
//     var final_date = max_date.splice(4,0, '-').splice(7,0,'-')

//     mindate = new Date('2020-03-02').getTime();
//     maxdate = new Date('2020-07-28').getTime();
//     $( "#slider" ).slider({
//       range: false,
//       min: mindate,
//       max: maxdate,
//       step: 86400000,
//       value: [ mindate ],
//       create: function(event, ui){
//         setSliderTicks(event.target)
//       },
//       slide: function(event, ui){
//         var cur_date = getFormattedDate(new Date(ui.value))

//         var tooltip = '<div class="tooltip_custom"><div class="tooltip-inner">' + cur_date + '</div><div class="tooltip-arrow"></div></div>';

//             $('.ui-slider-handle').html(tooltip); //attach tooltip to the slider handle

//       },
//       change: function(event, ui){

//         //get currently selected layer
//         var cur_layer = $('input[name="radgroup"]:checked').val()
//         var cur_date = getFormattedDate(new Date(ui.value))

//         var tooltip = '<div class="tooltip_custom"><div class="tooltip-inner">' + cur_date + '</div><div class="tooltip-arrow"></div></div>';

//         $('.ui-slider-handle').html(tooltip); //attach tooltip to the slider handle

//         counties = $.ajax({
// 		    url:"geojsons/20200601.geojson",
// 		    dataType: "json",
// 		    success: console.log("County data successfully loaded."),
// 		    error: function (xhr) {
// 		      alert(xhr.statusText)
// 		    }
// 		 })

//      //    var d = new Date(ui.value)

//      //    var date_fixed = d.yyyymmdd()

//      //    mymap.removeLayer(case_layer)
//      //    mymap.removeLayer(per_inc_layer)
//      //    mymap.removeLayer(rt_layer)
//      //    mymap.removeLayer(rt_three_layer)
//      //    mymap.removeLayer(rt_seven_layer)
//      //    mymap.removeLayer(death_layer)
//      //    mymap.removeLayer(doubling_layer)
//      //    mymap.removeLayer(infectprob_layer)

//      //    if(typeof testlayer !== "undefined"){
//     	// 	mymap.removeControl(testlayer)
//     	// }

//      //    if(cur_layer == 'case_count'){
//      //      var data_var = "case_count_" + date_fixed
//      //      buildCaseLayer(data_var)
//      //    } else if(cur_layer == 'per_inc'){
//      //      var data_var = "per_delta_" + date_fixed
//      //      buildDeltaLayer(data_var)
//      //    } else if(cur_layer == 'rt'){
//      //      var data_var = "r_t_" + date_fixed
//      //      buildRtLayer(data_var)
//      //    } else if(cur_layer == 'rt_three'){
//      //      var data_var = "r_t_three_" + date_fixed
//      //      buildRtThreeLayer(data_var)
//      //    } else if(cur_layer == 'deaths'){
//      //      var data_var = "deaths_" + date_fixed
//      //      buildDeathLayer(data_var)
//      //    } else if(cur_layer == 'doubling'){
//      //      var data_var = "doubling_" + date_fixed
//      //      buildDoublingLayer(data_var)
//      //    } else if(cur_layer == 'rt_seven'){
//      //      var data_var = "r_t_seven_" + date_fixed
//      //      buildRtSevenLayer(data_var)
//      //    } else if(cur_layer == 'infectprob'){
//      //      var data_var = "infect_prob_" + date_fixed
//      //      buildInfectProbLayer(data_var)
//      //    }

//         // $('.leaflet-control-layers-selector')[0].setAttribute('checked',true)
//       }
//     });


// function setSliderTicks(el) {
//     var $slider =  $(el);
//     var max =  $slider.slider("option", "max");    
//     var min =  $slider.slider("option", "min");        
//     var step = $slider.slider("option", "step");
//     var spacing =  100/((max - min)/step);

//     $slider.find('.ui-slider-tick-mark').remove();
//     for (var i = 0; i < ((max-min)/step) ; i++) {
//         $('<span class="ui-slider-tick-mark"></span>').css('left', (spacing * i) +  '%').appendTo($slider); 

//         if(i == 0){
//           d = new Date(mindate)
//           d_str = getFormattedDate(d)
//           var el = $('<label>' + d_str + '</label>').css('left', (spacing * i) + '%').appendTo($slider);
//         } else if(i == ((max-min)/step)-1){
//           d = new Date(maxdate)
//           d_str = getFormattedDate(d)
//           var el = $('<label>' + d_str + '</label>').css('left', (spacing * i) + '%').appendTo($slider);

//         }
//      }



// }




//    Date.prototype.yyyymmdd = function() {
//     var mm = this.getMonth() + 1; // getMonth() is zero-based
//     var dd = this.getDate();

//     return [this.getFullYear(),
//             (mm>9 ? '' : '0') + mm,
//             (dd>9 ? '' : '0') + dd
//            ].join('');
//   };

  
  //$("#pause").click( function() {
//	clearInterval(int);
  //})


//    $("#slider").slider("option", "value", maxdate)


//   //build base layer based on current selection on time slider
//     $('input[name="radgroup"]').change(function(e) { // Select the radio input group
//       var selection = $(this).val()

//       console.log(selection)

//       if(typeof testlayer !== "undefined"){
//     		mymap.removeControl(testlayer)
//     	}


//       mymap.removeLayer(case_layer)
//       mymap.removeLayer(per_inc_layer)
//       mymap.removeLayer(rt_layer)
//       mymap.removeLayer(rt_three_layer)
//       mymap.removeLayer(rt_seven_layer)
//       mymap.removeLayer(death_layer)
//       mymap.removeLayer(doubling_layer)
//       mymap.removeLayer(infectprob_layer)

//       if(selection == "per_inc"){

//         buildDeltaLayer('per_delta')

//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_per_delta.addTo(mymap);

//       } else if(selection == "case_count"){

//         buildCaseLayer('case_count')

//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_cases.addTo(mymap);

//       } else if(selection == "rt"){
//         buildRtLayer('r_t')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_rt.addTo(mymap);
//       } else if(selection == 'rt_three'){

//         buildRtThreeLayer('r_t_three')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_rt_three.addTo(mymap);
//       } else if(selection == 'rt_seven'){

//         buildRtSevenLayer('r_t_seven')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_rt_seven.addTo(mymap);
//       } else if(selection == 'deaths'){

//         buildDeathLayer('deaths')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_doubling)
//         mymap.removeControl(legend_infectprob)
//         legend_death.addTo(mymap);
//       } else if(selection == 'doubling'){

//         buildDoublingLayer('doubling')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_infectprob)
//         legend_doubling.addTo(mymap);
//       } else if(selection == 'infectprob'){

//         buildInfectProbLayer('infect_prob')

//         mymap.removeControl(legend_per_delta)
//         mymap.removeControl(legend_cases)
//         mymap.removeControl(legend_rt)
//         mymap.removeControl(legend_rt_three)
//         mymap.removeControl(legend_rt_seven)
//         mymap.removeControl(legend_death)
//         mymap.removeControl(legend_doubling)
//         legend_infectprob.addTo(mymap);
//       }

//      });




//   });

  //resize map height to full page
  $(window).on("resize", function () { $("#mapid").height($(window).height()); }).trigger("resize");



  

  </script>









</html>
