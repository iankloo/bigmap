#---surveys
st <- exp_st
exp_st
res <- exp_dt
res$uuid
st <- st[uuid %in% res$uuid]
#for survey
exp_st <- dbGetQuery(my_connection, paste0("SELECT id, question, response, date, uuid FROM surveyor_survey_results"))
exp_st <- data.table(exp_st)
#---surveys
st <- exp_st
res <- exp_dt
st <- st[uuid %in% res$uuid]
st$exp <- NA
st$name <- NA
for(i in 1:nrow(st)){
st$exp[i] <- res$experiment_name[res$uuid == st$uuid[i]][1]
st$name[i] <- res$rater.first[res$uuid == st$uuid[i]][1]
}
st
View(st)
library(httr)
library(jsonlite)
#prod
token <- '281ddaccf4f2d13593f26480a7a55f390dfb0fc0'
url_base <- 'https://appdseelo.azurewebsites.net/'
#example:
#get people to get their ID's
p <- get_people()
head(p)
tail(p)
token <- '33279afdeff2739066f3d9f36231ee35be7f139c'
url_base <- 'https://elorater.azurewebsites.net/'
#example:
#get people to get their ID's
p <- get_people()
head(p)
tail(p)
#prod
token <- '281ddaccf4f2d13593f26480a7a55f390dfb0fc0'
url_base <- 'https://appdseelo.azurewebsites.net/'
#example:
#get people to get their ID's
p <- get_people()
#set list of ID's to include in experiment
ids <- c(1,2,3,4)
head([])
head(p)
tail(p)
#set list of ID's to include in experiment
ids <- c(11,12,13,1317)
add_experiment('DemoFINAL', 'Ian Kloo', 'Who do you trust more?', 'Virtues', ids)
get_experiments()
# get_experiments()
#
t <- get_results(36)
dt <- data.table(first = t$rater$first, last = t$rater$last, id = t$uuid)
dt <- unique(dt)
dt
urls <- paste0(url_base, '?code=', dt$id)
urls
#---processing elo experiments
library(DBI)
library(odbc)
library(data.table)
library(ggplot2)
source('~/Documents/projects/Elo/interact_with_api.R')
#---preload stuff
exp_id <- 36
#db
my_connection <- dbConnect(drv = odbc::odbc(),
Driver = "ODBC Driver 17 for SQL Server",
server = "sqldbdseelo.database.windows.net,1433",
database = "sqldbdseelo",
uid = "sqldseeloadmin",
pwd = "642$GY%Tla8K")
#db
my_connection <- dbConnect(drv = odbc::odbc(),
Driver = "ODBC Driver 17 for SQL Server",
server = "sqldbdseelo.database.windows.net,1433",
database = "sqldbdseelo",
uid = "sqldseeloadmin",
pwd = "642$GY%Tla8K")
#db
my_connection <- dbConnect(drv = odbc::odbc(),
Driver = "ODBC Driver 17 for SQL Server",
server = "tcp:sqldseelo.database.windows.net,1433",
database = "sqldbdseelo",
uid = "sqldseeloadmin",
pwd = "642$GY%Tla8K")
#for survey
exp_st <- dbGetQuery(my_connection, paste0("SELECT id, question, response, date, uuid FROM surveyor_survey_results"))
exp_st <- data.table(exp_st)
#for virtues
exp_ft <- dbGetQuery(my_connection, paste0("SELECT experiment_name_id, rater_name_id, subject_name_id, does, virtue, comment FROM rater_comments"))
exp_ft <- data.table(exp_ft)
#for pairwise
exp_dt <- data.table(get_results(exp_id))
#for multiple
p <- data.table(get_people())
#---pairwise ratings
dt <- exp_dt
dt$winner_name <- NA
for(i in 1:nrow(dt)){
dt$winner_name[i] <- dt$name_1.first[which(dt$winner[i] == dt$name_1.id)][1]
if(is.na(dt$winner_name[i])){
dt$winner_name[i] <- dt$name_2.first[which(dt$winner[i] == dt$name_2.id)][1]
}
}
dt$loser_name <- NA
for(i in 1:nrow(dt)){
if(dt$winner_name[i] == dt$name_1.first[i]){
dt$loser_name[i] <- dt$name_2.first[i]
} else{
dt$loser_name[i] <- dt$name_1.first[i]
}
}
dt
View(dt)
#---virtue comments
ft <- exp_ft
ft <- ft[experiment_name_id == exp_id]
ft$rater_name <- NA
for(i in 1:nrow(ft)){
ft$rater_name[i] <- p$first[p$id == ft$rater_name_id[i]]
}
ft$subject_name <- NA
for(i in 1:nrow(ft)){
ft$subject_name[i] <- p$first[p$id == ft$subject_name_id[i]]
}
ft
#---surveys
st <- exp_st
res <- exp_dt
st <- st[uuid %in% res$uuid]
st$exp <- NA
st$name <- NA
for(i in 1:nrow(st)){
st$exp[i] <- res$experiment_name[res$uuid == st$uuid[i]][1]
st$name[i] <- res$rater.first[res$uuid == st$uuid[i]][1]
}
st
View(st)
#---load cadets
library(data.table)
source('~/Documents/projects/Elo/interact_with_api.R')
df <- fread('~/Downloads/cft_roster_0722.csv')
#---load cadets
library(data.table)
source('~/Documents/projects/Elo/interact_with_api.R')
df <- fread('~/Downloads/cft_roster_0722.csv')
df
#make sure everyone is in the database
p <- get_people()
sub <- df[1]
sub
parse_name <- function(n){
num_space <- sum(unlist(strsplit(n, '')) == ' ')
if(num_space == 1){
last <- gsub('(.+) .+', '\\1', n)
first <- gsub('.+ (.+)', '\\1', n)
middle <- ''
} else if(num_space == 2){
last <- gsub('(.+) .+ .+', '\\1', n)
first <- gsub('.+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ (.+)', '\\1', n)
} else if(num_space == 3){
last <- gsub('(.+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ (.+)', '\\1', n)
} else if(num_space == 4){
last <- gsub('(.+ .+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ .+ (.+)', '\\1', n)
} else{
last <- first <- middle <- NA
}
return(data.table(first, middle, last))
}
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
df <- cbind(df, final)
df
0 <- 1
i <- 1
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
#make sure everyone is in the database
p <- data.table(get_people())
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
df[i, first]
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
df <- df[, c('first','middle','last','EMAIL')]
df$rank <- 'CDT'
colnames(df)[4] <- 'email'
df <- fread('~/Downloads/cft_roster_0722.csv')
parse_name <- function(n){
num_space <- sum(unlist(strsplit(n, '')) == ' ')
if(num_space == 1){
last <- gsub('(.+) .+', '\\1', n)
first <- gsub('.+ (.+)', '\\1', n)
middle <- ''
} else if(num_space == 2){
last <- gsub('(.+) .+ .+', '\\1', n)
first <- gsub('.+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ (.+)', '\\1', n)
} else if(num_space == 3){
last <- gsub('(.+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ (.+)', '\\1', n)
} else if(num_space == 4){
last <- gsub('(.+ .+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ .+ (.+)', '\\1', n)
} else{
last <- first <- middle <- NA
}
return(data.table(first, middle, last))
}
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
df <- cbind(df, final)
df <- df[, c('first','middle','last','EMAIL')]
df$rank <- 'CDT'
colnames(df)[4] <- 'email'
df <- fread('~/Downloads/cft_roster_0722.csv')
parse_name <- function(n){
num_space <- sum(unlist(strsplit(n, '')) == ' ')
if(num_space == 1){
last <- gsub('(.+) .+', '\\1', n)
first <- gsub('.+ (.+)', '\\1', n)
middle <- ''
} else if(num_space == 2){
last <- gsub('(.+) .+ .+', '\\1', n)
first <- gsub('.+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ (.+)', '\\1', n)
} else if(num_space == 3){
last <- gsub('(.+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ (.+)', '\\1', n)
} else if(num_space == 4){
last <- gsub('(.+ .+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ .+ (.+)', '\\1', n)
} else{
last <- first <- middle <- NA
}
return(data.table(first, middle, last))
}
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
df <- cbind(df, final)
df <- df[, c('first','middle','last','Email')]
df$rank <- 'CDT'
colnames(df)[4] <- 'email'
#make sure everyone is in the database
p <- data.table(get_people())
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
i <- 1
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
for(i in 1:nrow(df)){
if(nrow(p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]) == 0){
print(i)
}
}
i <- 1
nrow(p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]) == 0
View(p)
p_df <- df[i, -c('db_id', 'squadID')]
p_df <- df[i]
p_df
df <- fread('~/Downloads/cft_roster_0722.csv')
parse_name <- function(n){
num_space <- sum(unlist(strsplit(n, '')) == ' ')
if(num_space == 1){
last <- gsub('(.+) .+', '\\1', n)
first <- gsub('.+ (.+)', '\\1', n)
middle <- ''
} else if(num_space == 2){
last <- gsub('(.+) .+ .+', '\\1', n)
first <- gsub('.+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ (.+)', '\\1', n)
} else if(num_space == 3){
last <- gsub('(.+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ (.+)', '\\1', n)
} else if(num_space == 4){
last <- gsub('(.+ .+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ .+ (.+)', '\\1', n)
} else{
last <- first <- middle <- NA
}
return(data.table(first, middle, last))
}
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
View(final)
df <- fread('~/Downloads/cft_roster_0722.csv')
parse_name <- function(n){
num_space <- sum(unlist(strsplit(n, '')) == ' ')
if(num_space == 1){
last <- gsub('(.+) .+', '\\1', n)
first <- gsub('.+ (.+)', '\\1', n)
middle <- ''
} else if(num_space == 2){
last <- gsub('(.+) .+ .+', '\\1', n)
first <- gsub('.+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ (.+)', '\\1', n)
} else if(num_space == 3){
last <- gsub('(.+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ (.+)', '\\1', n)
} else if(num_space == 4){
last <- gsub('(.+ .+ .+) .+ .+', '\\1', n)
first <- gsub('.+ .+ .+ (.+) .+', '\\1', n)
middle <- gsub('.+ .+ .+ .+ (.+)', '\\1', n)
} else{
last <- first <- middle <- NA
}
return(data.table(first, middle, last))
}
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
df <- cbind(df, final)
df <- df[, c('first','middle','last','Email')]
df$rank <- 'CDT'
colnames(df)[4] <- 'email'
#make sure everyone is in the database
p <- data.table(get_people())
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]
for(i in 1:nrow(df)){
if(nrow(p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email]]) == 0){
p_df <- df[i]
add_people(p_df)
print(p_df)
}
}
df <- fread('~/Downloads/cft_roster_0722.csv')
out <- lapply(df$NAME, parse_name)
final <- rbindlist(out)
df <- cbind(df, final)
df[, squadID := paste0(SUMCO, SUMPLT, SUMSQD)]
df <- df[, c('first','middle','last','Email', 'squadID')]
df$rank <- 'CDT'
colnames(df)[4] <- 'email'
View(df)
table(df$squadID)
u_squad <- unique(df$squadID)
u_squad
i <- 1
sub <- df[squadID == u_squad[i]]
sub
ids <- as.numeric(sub[, db_id])
df$db_id <- ''
for(i in 1:nrow(df)){
df[i, 'db_id'] <- p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email], id]
}
i <- 1
df$db_id <- ''
p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email], id]
df[i, first]
middle == df[i, middle]
df[i, middle]
df[i, last]
df[i, email]
p <- data.table(get_people())
df$db_id <- ''
for(i in 1:nrow(df)){
df[i, 'db_id'] <- p[first == df[i, first] & middle == df[i, middle] & last == df[i, last] & email == df[i, email], id]
}
View(df)
u_squad <- unique(df$squadID)
i <- 1
sub <- df[squadID == u_squad[i]]
ids <- as.numeric(sub[, db_id])
ids
name <- paste0('CFT Initial Peer Ratings: ', u_squad[i])
name
#make sure you can load these, if not do install.packages('data.table') substituting the names of the other libraries you need
library(data.table)
library(httr)
library(jsonlite)
#-toggle cft/cldt by commenting one of them out
group <- 'CFT'
#---get results from DB
token <- '281ddaccf4f2d13593f26480a7a55f390dfb0fc0'
url_base <- 'https://appdseelo.azurewebsites.net/'
get_experiments <- function(){
url <- paste0(url_base, 'api/v1/exp_external/')
full_token <- paste0('Token ', token)
res <- GET(url, add_headers(Authorization = full_token))
if(res$status_code == 200){
results <- fromJSON(content(res, 'text', encoding = 'latin1'))
return(results)
} else{
stop(paste0('in API call. Status code: ', res$status_code))
}
}
get_results <- function(exp_id){
url <- paste0(url_base, '/api/v1/res_external/?exp_id=', exp_id)
full_token <- paste0('Token ', token)
res <- GET(url, add_headers(Authorization = full_token))
if(res$status_code == 200){
results <- fromJSON(content(res, 'text', encoding = 'latin1'))
return(results)
} else{
stop(paste0('in API call. Status code: ', res$status_code))
}
}
exp <- get_experiments()
exp <- data.table(exp)
exps <- exp[grep(group, exp$title)]
rater_cols <- c('rater.id', 'rater.first', 'rater.middle', 'rater.last', 'rater.email', 'uuid')
out <- list()
pb <- txtProgressBar(max = nrow(exps), style = 3)
for(i in 1:nrow(exps)){
ex_id <- exps[i, id]
r <- data.table(get_results(ex_id))
all <- r[, rater_cols, with = FALSE]
all <- unique(all)
all$complete <- ''
for(j in 1:nrow(all)){
s <- r[rater.id == all$rater.id[j]]
if(TRUE %in% is.na(s$end)){
all[j, 'complete'] <- 'no'
}else{
all[j, 'complete'] <- 'yes'
}
}
all[, squadID := gsub(paste0(group, ' Initial Peer Ratings: (.*)'), '\\1', exps$title[i])]
out[[i]] <- all
setTxtProgressBar(pb, i)
}
report <- rbindlist(out)
print(paste0(100 * round(sum(report$complete == 'yes') / nrow(report), 4), '% complete'))
fwrite(report, paste0(group, '_report.csv'))
reticulate::repl_python()
shiny::runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
runApp('working/chat_vis')
#---improved munge script for covid data
suppressWarnings({
suppressMessages({
library(data.table)
library(RSQLite)
library(DBI)
library(dplyr)
library(dbplyr)
library(mixdist)
library(extraDistr)
library(jsonlite)
library(geojsonio)
library(sp)
})
})
setwd('~/working/cov_api/')
#functions used
rt.func.v2<-function(dat,mean.Weibull=4.8,sd.Weibull=2.3){
r.vals<-numeric(length = (length(dat) - 2))
#get the Weibull parameters from mixdist's weibullpar function
mGT.params<-weibullpar(mean.Weibull, sd.Weibull, loc = 0)
alpha<-mGT.params[2] # called shape in weibullpar, alpha in a discrete Weilbull
beta<-mGT.params[1] # called scale in weibullpar, beta in a discrete Weibull
#the extraDistr package uses an altrnative parameterization of the Weibull (q, beta) from
#Nakagawa and Osaki (1975) where q = exp(-alpha^-beta), so...
q<-exp(-as.numeric(alpha)^(-as.numeric(beta)))
#Discretize Weibull via the extraDistr package's ddweibull function
w<- ddweibull(0:1000, as.numeric(q), as.numeric(beta), log = FALSE)
growth<-diff(dat)
growth<-pmax(growth, 0) # eliminate any erroneous downward shifts in the cumulative counts
#Estimate R(t) from equation (33) of Nishiura and Chowell (2009)
for(k in 2:length(growth)){
r.vals[k-1]<-growth[k]/(sum(growth[1:k]*rev(w[1:k])))
}
#Output the results
return(c(NA, NA, r.vals))
}
covid_db <- dbConnect(RSQLite::SQLite(), 'data/covid_db.sqlite')
#---check if need to update
suppressWarnings({
suppressMessages({
x <- tbl(covid_db, 'counties') %>%
filter(date == max(date, na.rm = TRUE)) %>%
select(date) %>%
collect()
})
})
db_date <- as.Date(x[1][[1]][1])
main <- fread('https://usafactsstatic.blob.core.windows.net/public/data/covid-19/covid_confirmed_usafacts.csv', colClasses = 'character', showProgress = FALSE)
main <- main[countyFIPS != '0']
keep_cols <- grep('V',colnames(main), invert = TRUE)
main <- main[, keep_cols, with=FALSE]
facts_date <- as.Date(colnames(main)[length(colnames(main))], format = '%m/%d/%y')
source('~/working/bigmap_api/create_files.R')
reticulate::repl_python()
